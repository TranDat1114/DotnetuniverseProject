<!DOCTYPE html>
<html lang="en" ng-app="myApp">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{pageTitle}} - DotNetUniverse</title>
    <link rel="shortcut icon" href="./assets/favicon.ico" type="image/x-icon">
    <script src="https://kit.fontawesome.com/4552defb60.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="./bootstrap-5.3.0-alpha1/css/bootstrap.min.css">
    <!-- my Style -->
    <link rel="stylesheet" href="./css/stylesToAll.css">
    <link rel="stylesheet" href="./css/styleAboutUs.css">
    <link rel="stylesheet" href="./css/styleBlogReading.css">
    <link rel="stylesheet" href="./css/styleHome.css">
    <link rel="stylesheet" href="./css/styleProfile.css">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.js"></script>
</head>

<body ng-controller="allElement" data-bs-theme="{{themes.theme}}">
    <div>
        <!-- progress -->
        <div class="progress sticky-top" role="progressbar" aria-label="Warning example" aria-valuenow="75"
            aria-valuemin="0" aria-valuemax="100" style="height: 5px;">
            <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" id="progress-bar"
                style="width: 0%">
            </div>
        </div>
        <!-- nav -->
        <div ng-include="'share/nav.html'"></div>
        <!-- loading -->
        <div class="container vh-100" ng-show="loading" ng-include="'share/loading.html'">
        </div>
        <div ng-show="!loading" ng-view id="Home"></div>
        <div ng-include="'share/footer.html'"></div>
    </div>

    <!-- Toast -->
    <div class="position-sticky top-0 start-0 end-0 bottom-0">
        <div class="toast-container bottom-0 end-0 p-3">
            <div class="toast fade show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <img src="./assets/logo.svg" height="32" class="rounded-circle me-2" alt="Logo">
                    <strong class="me-auto">DotNetUniverse</strong>
                    <small class="text-muted" data-bs-toggle="tooltip" data-bs-title="Up vote">Just now</small>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"
                        title="toast-close"></button>
                </div>
                <div class="toast-body">
                    <p class="h5">
                        Xin chào Trần Phú Đạt
                    </p>
                    <p class="h6">
                        Chúc bạn một ngày tốt lành!!
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- add lottiefiles -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="./bootstrap-5.3.0-alpha1/js/bootstrap.bundle.min.js"></script>
    <!-- scrollprogress -->
    <script src="./js/scrollProgress.js"></script>
    <!-- tooltip -->
    <!-- <script src="./js/whenHrefChange.js"></script> -->
    <!-- AngularJs -->
    <script>
        var app = angular.module('myApp', ["ngRoute"]);
        app.controller('allElement', function ($scope, $http, $rootScope) {
            $rootScope.pageTitle = "Trang chủ";
            $rootScope.isLoginNow = false;
            $rootScope.UserNow = [];
            $rootScope.language = "vn";

            $scope.themes = {
                "theme": "dark", "content": false
            };
            $scope.changeTheme = () => {
                if ($scope.themes.theme === "light") {
                    $scope.themes.theme = "dark";
                    $scope.themes.content = false;
                } else {
                    $scope.themes.theme = "light";
                    $scope.themes.content = true;
                }
            }
            $rootScope.DataFile = [];
            // data
            $http.get("./js/Data.json").then((response) => {
                $rootScope.DataFile = response.data;
            })


        })
        app.controller('navBar', function ($scope, $rootScope) {
            $scope.listReadTime = $rootScope.DataFile.ListReadTime;

            $scope.SearchTitle;
            $scope.SearchTopic;
            $scope.SearchTime;
        });
        app.controller('loginCtrl', function ($scope, $rootScope) {

        });

        app.controller('searchCtrl', ($scope, $http) => {
            $scope.search = {
                "title": "",
                "topic": "Tất cả",
                "time": "0"
            }
        });

        app.controller('BlogReading', function ($scope, $rootScope) {
            // $scope.BlogReadings = $rootScope.DataFile.Blogs;
            $scope.pageSize = 4;
            $scope.currentPage = 0;
        });

        app.controller('blogCtrl', function ($scope, $routeParams, $http, $sce, $rootScope) {
            $scope.Blog = $rootScope.DataFile.Blogs.filter(blog => blog.content === $routeParams.name)[0];
            $http.get("./ContentHTML/" + $scope.Blog.content + ".html").then((rp) => {
                $scope.htmlBlog = $sce.trustAsHtml(rp.data);
            });
            $scope.htmlBlog;

        });

        app.controller('pageTitleChange', function ($scope, $routeParams, $rootScope) {
            // console.log($routeParams.title)
            $rootScope.pageTitle = $routeParams.title;
        });
        app.controller('searchPage', function ($scope, $routeParams, $rootScope, $http) {
            // console.log($routeParams.title)
            $rootScope.searchKey = $routeParams;
            $rootScope.pageTitle = "Search";
            $rootScope.BlogInSearch;
            $http.get("./js/Data.json").then((response) => {
                $rootScope.BlogInSearch = response.data.Blogs
                if ($rootScope.searchKey.title.trim() != "") {
                    $rootScope.BlogInSearch = $rootScope.BlogInSearch.filter((blog) => blog.blogName.toLowerCase().includes($rootScope.searchKey.title.toLowerCase()));
                }
                if ($rootScope.searchKey.topic != "Tất cả") {
                    $rootScope.BlogInSearch = $rootScope.BlogInSearch.filter((blog) =>
                        blog.topic === $rootScope.searchKey.topic
                    );
                }

                // Đang làm việc ở đây
                if ($rootScope.searchKey.time != 0) {
                    $rootScope.BlogInSearch = $rootScope.BlogInSearch.filter((blog) => Number(blog.readingTime.split(" ")[0]) <= Number($rootScope.searchKey.time));
                }
                $rootScope.searchKey.time = response.data.ListReadTime.filter(p => p.value == $routeParams.time)[0].content

                // search with title cần tối ưu (include từng phần tử trong keyword)
            })
        })

        app.controller('profileUser', function ($scope, $routeParams, $rootScope) {
            $scope.Profile = $rootScope.DataFile.Users.filter(user => user.userName === $routeParams.username)[0];
            $scope.BlogsInProfile = $rootScope.DataFile.Blogs.filter(blog => blog.userName === $routeParams.username)
        });

        app.filter('startFrom', function () {
            return function (input, start) {
                start = +start; //parse to int
                return input.slice(start);
            }
        });

        app.config(function ($routeProvider) {
            $routeProvider
                .when("/", {
                    templateUrl: "./screen/Home.html?"
                })
                .when("/home/:title", {
                    templateUrl: "./screen/Home.html?",
                    controller: "pageTitleChange"
                })
                .when("/faqs/:title", {
                    templateUrl: "./screen/FAQs.html?",
                    controller: "pageTitleChange"
                })
                .when("/aboutus/:title", {
                    templateUrl: "./screen/AboutUs.html?",
                    controller: "pageTitleChange"
                })
                .when("/signup/:title", {
                    templateUrl: "./screen/SignUp.html?",
                    controller: "pageTitleChange"
                })
                .when("/login/:title", {
                    templateUrl: "./screen/Login.html?",
                    controller: "pageTitleChange"
                })
                .when("/profile/:username", {
                    templateUrl: "./screen/Profile.html?"
                    // controller: "profileUser"
                })
                .when("/BlogReading/:name", {
                    templateUrl: "./screen/BlogReading.html?",
                    controller: "blogCtrl"
                })
                .when("/404notfound", {
                    templateUrl: "./screen/404NotFound.html?"
                })
                .when("/search/:title/:topic/:time", {
                    templateUrl: "./screen/SearchPage.html?",
                    controller: "searchPage"
                })
                .otherwise({
                    redirectTo: "/404notfound"
                })
                ;
        });

        // loading
        app.run(($rootScope, $timeout) => {
            $rootScope.$on('$routeChangeStart', () => {
                $rootScope.loading = true;
            });
            $rootScope.$on('$routeChangeSuccess', () => {
                // $timeout(() => {
                $rootScope.loading = false;

                // }, 250);
            });
            $rootScope.$on('$routeChangeError', () => {
                $timeout(() => {
                    alert("Có vẻ kết nối của bạn không ổn định");
                    $rootScope.loading = false;
                }, 1000);
            })
        });

    </script>
</body>

</html>